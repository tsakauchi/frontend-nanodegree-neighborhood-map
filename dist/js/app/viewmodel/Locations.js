define(["app/globals","jquery","underscore","knockout","googlemaps","app/model/Location"],function(a,b,c,d,e,f){"use strict";return function(c,g){var h=this;h.map=g,h.geocoder=new e.Geocoder,h.bounds=new e.LatLngBounds,h.locations=d.observableArray(d.utils.arrayMap(c,function(a){return new f(a.name)})),h.filter=d.observable(""),h.isFilterCaseSensitive=d.observable(!1),h.activeLocation=null,h.addMarker=function(a){var b=a.marker;if(b)return b.setMap(h.map),h.bounds.extend(b.position),void h.map.fitBounds(h.bounds);var c=a.name();h.geocoder.geocode({address:c},function(d,f){if(f==e.GeocoderStatus.OK){var g=d[0].geometry.location;h.bounds.extend(g);var i="<h2>"+c+"</h2>";b=new e.Marker({map:h.map,position:g,title:c,animation:e.Animation.DROP});var j=new e.InfoWindow({content:i});a.position=g,a.marker=b,a.infoWindow=j,e.event.addListener(b,"click",function(){h.setActiveLocation(a)}),e.event.addListener(j,"closeclick",function(){h.setActiveLocation(null)}),h.loadInfoWindowTextFromWikipedia(c,a.infoWindow),h.loadInfoWindowTextFromNewYorkTimes(c,a.infoWindow),h.loadInfoWindowImageFromGoogleMaps(c,a.infoWindow),h.map.fitBounds(h.bounds)}else console.log("Geocode was not successful for the following reason: "+f)})},h.loadInfoWindowImageFromGoogleMaps=function(a,b){var c=300,d=100,e="https://maps.googleapis.com/maps/api/streetview?size="+c+"x"+d+"&location="+a+"&heading=0&pitch=0";b.content+="<h3>Street View</h3>",b.content+='<img class="bgimg" src="'+e+'">'},h.loadInfoWindowTextFromWikipedia=function(a,c){var d="action=opensearch",e="search="+a,f="format=json",g="https://en.wikipedia.org/w/api.php?"+d+"&"+e+"&"+f,h=function(){console.log("Failed to get Wikipedia articles for "+a),clearTimeout()},i=setTimeout(h,4e3),j=function(b){if(b&&b[1]&&b[2]&&b[3]){var d=b[1],e=b[2],f=b[3];d.length>0?(c.content+="<h3>Wikipedia</h3>",c.content+="<p>"+e[0]+"</p><p>"+f[0]+"</p>"):console.log("No Wikipedia entry found for "+a),clearTimeout(i)}};b.ajax({url:g,dataType:"jsonp",type:"POST",success:j})},h.loadInfoWindowTextFromNewYorkTimes=function(a,c){var d='fq=type_of_material:("News") AND "'+a+'"',e="sort=newest",f="fl=headline,pub_date,snippet,web_url",g="api-key=9df2b415e47006caa7d29120aeec20f6:9:74652536",h="http://api.nytimes.com/svc/search/v2/articlesearch.json?"+d+"&"+e+"&"+f+"&"+g,i=function(b){if(b&&b.response&&b.response.docs)if(b.response.docs.length>0){var d=b.response.docs[0];c.content+="<h3>New York Times</h3>",c.content+="<h4>"+d.headline.main+"</h4>",c.content+="<p>"+d.snippet+"</p><p>"+d.web_url+"</p>"}else console.log("No NYT entry found for "+a)},j=function(){console.log("Failed to get New York Times articles for "+a)};b.getJSON(h,i).fail(j)},h.add=function(a){h.locations.push(a)},h.submitEventHandler=function(a){var c=b(a),d=c.find("#location"),e=d.val();h.add(new f(e)),d.val("")},h.locationClickEventHandler=function(a){h.setActiveLocation(a)},h.setActiveLocation=function(a){h.activeLocation&&h.activeLocation.infoWindow&&(h.activeLocation.marker.setIcon(""),h.activeLocation.marker.setAnimation(null),h.activeLocation.infoWindow.close()),a&&a.infoWindow&&(a.infoWindow.open(h.map,a.marker),h.activeLocation=a,h.activeLocation.marker.setIcon("http://mt.google.com/vt/icon?psize=30&font=fonts/arialuni_t.ttf&color=ff304C13&name=icons/spotlight/spotlight-waypoint-a.png&ax=43&ay=48&text=%E2%80%A2"),h.activeLocation.marker.setAnimation(e.Animation.BOUNCE))},h.remove=function(a){h.removeMarker(a),h.locations.remove(a)},h.removeMarker=function(a){a.marker&&a.marker.setMap(null)},h.addAllMarkers=function(){d.utils.arrayForEach(h.locations(),function(a){h.addMarker(a)})},h.locationsFiltered=d.computed(function(){return h.bounds=new e.LatLngBounds,h.filter()?d.utils.arrayFilter(h.locations(),function(a){var b,c=a.name(),d=h.filter();return b=h.isFilterCaseSensitive()?c.indexOf(d)>-1:c.toLowerCase().indexOf(d.toLowerCase())>-1,b?(h.addMarker(a),!0):(h.removeMarker(a),!1)}):(h.addAllMarkers(),h.locations())}),d.computed(function(){var b=[];d.utils.arrayForEach(h.locations(),function(a){b.push(a.persistedLocation())}),window.localStorage.setItem(a.LOCAL_STORAGE_ITEM_KEY,d.toJSON(b))}).extend({rateLimit:{timeout:500,method:"notifyWhenChangesStop"}})}});